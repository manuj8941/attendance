<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin Dashboard</title>
        <style>
            body {
                font-family: sans-serif;
                margin: 2em;
            }

            h1,
            h2 {
                color: #333;
            }

            .container {
                max-width: 1200px;
                margin: auto;
            }

            .section {
                background-color: #f4f4f4;
                padding: 1em;
                margin-top: 1em;
                border-radius: 5px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 1em;
            }

            th,
            td {
                padding: 0.5em;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }

            th {
                background-color: #e9e9e9;
            }

            .approve-btn,
            .reject-btn {
                padding: 5px 10px;
                border: none;
                color: white;
                border-radius: 3px;
                cursor: pointer;
            }

            .approve-btn {
                background-color: #28a745;
            }

            .reject-btn {
                background-color: #dc3545;
            }

            .status-pending {
                color: orange;
            }

            .status-approved {
                color: green;
            }

            .status-rejected {
                color: red;
            }
        </style>
        <link rel="stylesheet" href="/css/mobile.css">
        <script src="/js/ui.js"></script>
    </head>

    <body>
        <div class="container">
            <h1>Admin Dashboard</h1>
            <p>Welcome, <strong id="admin-name"></strong>! (<span id="admin-role"></span>) <span
                    id="back-link-container"></span> | <a href="/logout">Logout</a></p>

            <!-- Section for Leave Request Management -->
            <div class="section">
                <h2>Pending Leave Requests</h2>
                <table id="leave-requests-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Reason</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="leave-requests-body"></tbody>
                </table>
            </div>

            <!-- Section for All Leaves History -->
            <div class="section">
                <h2>All Leave Requests</h2>
                <table id="all-leaves-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Reason</th>
                            <th>Status</th>
                            <th>Approved By</th>
                        </tr>
                    </thead>
                    <tbody id="all-leaves-body"></tbody>
                </table>
            </div>

            <!-- Section for Viewing Employee Attendance -->
            <div class="section">
                <h2>Add New User</h2>
                <form id="add-user-form">
                    <label for="new-username">Username:</label>
                    <input type="text" id="new-username" name="name" required pattern="[A-Za-z0-9_]+">
                    <br><br>
                    <label for="new-password">Password (optional, default 111):</label>
                    <input type="text" id="new-password" name="password" placeholder="111">
                    <br><br>
                    <label for="new-role">Role:</label>
                    <select id="new-role" name="role">
                        <option value="employee">Employee</option>
                        <option value="employee_admin">Employee Admin</option>
                        <option value="owner_admin">Owner Admin</option>
                    </select>
                    <br><br>
                    <button type="submit">Add User</button>
                </form>
                <hr>
                <h2>Reset Passwords</h2>
                <form id="reset-password-form">
                    <label>Reset Target:</label>
                    <br>
                    <select id="reset-target" name="reset_target">
                        <option value="">-- Select a user to reset --</option>
                        <!-- specific users will be appended here -->
                    </select>
                    <br><br>
                    <label for="reset-password">New password (optional, default 111):</label>
                    <input type="text" id="reset-password" name="password" placeholder="111">
                    <br><br>
                    <button type="submit">Reset Password</button>
                </form>
                <hr>
                <h2>View Employee Attendance</h2>
                <label for="user-select">Select Employee:</label>
                <select id="user-select"></select>
                <table id="attendance-viewer-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>In Time</th>
                            <th>In Location</th>
                            <th>In Selfie</th>
                            <th>Out Time</th>
                            <th>Out Location</th>
                            <th>Out Selfie</th>
                            <th>Total Time</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-viewer-body"></tbody>
                </table>
            </div>
        </div>

        <script>
            let currentUser;

            window.addEventListener( 'load', async () =>
            {
                // Fetch current admin's info
                const userRes = await fetch( '/user/me' );
                currentUser = await userRes.json();
                document.getElementById( 'admin-name' ).textContent = currentUser.name;
                document.getElementById( 'admin-role' ).textContent = currentUser.role.replace( '_', ' ' );

                // Show Back to Dashboard link for non-owner admins (employee_admin)
                if ( currentUser.role !== 'owner_admin' )
                {
                    document.getElementById( 'back-link-container' ).innerHTML = ' | <a href="/dashboard">Back to Dashboard</a>';
                }

                // Load all necessary data
                await loadLeaveRequests();
                await loadAllLeaves();
                await populateUserDropdown();
                setupAddUserForm();
            } );

            function setupAddUserForm ()
            {
                const form = document.getElementById( 'add-user-form' );
                const roleSelect = document.getElementById( 'new-role' );
                // If the current admin is an employee_admin, remove the owner_admin option
                if ( currentUser && currentUser.role === 'employee_admin' )
                {
                    const ownerOption = roleSelect.querySelector( 'option[value="owner_admin"]' );
                    if ( ownerOption ) ownerOption.remove();
                }
                form.addEventListener( 'submit', async ( e ) =>
                {
                    e.preventDefault();
                    const name = document.getElementById( 'new-username' ).value.trim();
                    const password = document.getElementById( 'new-password' ).value;
                    const role = document.getElementById( 'new-role' ).value;

                    try
                    {
                        const res = await fetch( '/admin/users/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify( { name, password, role } )
                        } );
                        const result = await res.json();
                        if ( res.ok && result.success )
                        {
                            showAppModal( 'User created successfully.', 'success' );
                            form.reset();
                            populateUserDropdown();
                        } else
                        {
                            showAppModal( result.message || 'Could not create the user. Please try again.', 'error' );
                        }
                    } catch ( err )
                    {
                        console.error( err );
                        showAppModal( 'An error occurred while creating the user. Please try again.', 'error' );
                    }
                } );

                // Reset passwords handler
                const resetForm = document.getElementById( 'reset-password-form' );
                resetForm.addEventListener( 'submit', async ( e ) =>
                {
                    e.preventDefault();
                    const password = document.getElementById( 'reset-password' ).value;
                    const target = document.getElementById( 'reset-target' ).value;

                    if ( !target )
                    {
                        showAppModal( 'Please choose a user to reset.', 'error' );
                        return;
                    }

                    try
                    {
                        const res = await fetch( '/admin/users/reset-password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify( { username: target, password } )
                        } );
                        const result = await res.json();
                        if ( res.ok && result.success )
                        {
                            showAppModal( result.message, 'success' );
                        } else
                        {
                            showAppModal( result.message || 'Failed to reset the user\'s password. Please try again.', 'error' );
                        }
                    } catch ( err )
                    {
                        console.error( err );
                        showAppModal( 'We could not reset the password right now. Please try again.', 'error' );
                    }
                } );


            }


            // --- LEAVE MANAGEMENT ---
            async function loadLeaveRequests ()
            {
                const res = await fetch( '/admin/leaves' );
                const leaves = await res.json();
                const tbody = document.getElementById( 'leave-requests-body' );
                tbody.innerHTML = '';
                if ( leaves.length === 0 )
                {
                    tbody.innerHTML = '<tr><td colspan="5">No pending leave requests.</td></tr>';
                    return;
                }
                leaves.forEach( leave =>
                {
                    const tr = document.createElement( 'tr' );
                    tr.innerHTML = `
                    <td>${ leave.username }</td>
                    <td>${ leave.start_date }</td>
                    <td>${ leave.end_date }</td>
                    <td>${ leave.reason }</td>
                    <td>
                        <button class="approve-btn" onclick="handleLeaveAction(${ leave.leave_id }, 'approved')">Approve</button>
                        <button class="reject-btn" onclick="handleLeaveAction(${ leave.leave_id }, 'rejected')">Reject</button>
                    </td>
                `;
                    tbody.appendChild( tr );
                } );
            }

            async function loadAllLeaves ()
            {
                const res = await fetch( '/admin/leaves/history' );
                const leaves = await res.json();
                const tbody = document.getElementById( 'all-leaves-body' );
                tbody.innerHTML = '';
                if ( leaves.length === 0 )
                {
                    tbody.innerHTML = '<tr><td colspan="6">No leave requests found.</td></tr>';
                    return;
                }
                leaves.forEach( leave =>
                {
                    const tr = document.createElement( 'tr' );
                    tr.innerHTML = `
                    <td>${ leave.username }</td>
                    <td>${ leave.start_date }</td>
                    <td>${ leave.end_date }</td>
                    <td>${ leave.reason }</td>
                    <td class="status-${ leave.status }">${ leave.status }</td>
                    <td>${ leave.approved_by || '' }</td>
                `;
                    tbody.appendChild( tr );
                } );
            }

            async function handleLeaveAction ( leave_id, status )
            {
                await fetch( '/admin/leaves/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify( { leave_id, status } )
                } );
                loadLeaveRequests(); // Refresh the list
                loadAllLeaves(); // Refresh all leaves list
            }

            // --- ATTENDANCE VIEWER ---
            async function populateUserDropdown ()
            {
                const res = await fetch( '/admin/users' );
                const users = await res.json();
                const select = document.getElementById( 'user-select' );
                select.innerHTML = '<option value="">-- Select an employee --</option>';
                const resetSelect = document.getElementById( 'reset-target' );
                // clear existing options
                if ( resetSelect )
                {
                    resetSelect.innerHTML = '<option value="">-- Select a user to reset --</option>';
                }
                users.forEach( user =>
                {
                    if ( user.role !== 'owner_admin' )
                    { // Owner admin attendance is not tracked
                        const option = document.createElement( 'option' );
                        option.value = user.name;
                        option.textContent = `${ user.name } (${ user.role.replace( '_', ' ' ) })`;
                        select.appendChild( option );
                    }

                    // Add to reset-target select for specific user reset
                    if ( resetSelect )
                    {
                        // owner_admin sees all users; employee_admin sees employee_admin and employee; never include other users beyond those
                        if ( currentUser && currentUser.role === 'owner_admin' )
                        {
                            const rOpt = document.createElement( 'option' );
                            rOpt.value = user.name;
                            rOpt.textContent = `${ user.name } (${ user.role.replace( '_', ' ' ) })`;
                            resetSelect.appendChild( rOpt );
                        } else if ( currentUser && currentUser.role === 'employee_admin' )
                        {
                            if ( user.role === 'employee' || user.role === 'employee_admin' )
                            {
                                const rOpt = document.createElement( 'option' );
                                rOpt.value = user.name;
                                rOpt.textContent = `${ user.name } (${ user.role.replace( '_', ' ' ) })`;
                                resetSelect.appendChild( rOpt );
                            }
                        }
                    }
                } );
                select.addEventListener( 'change', ( e ) =>
                {
                    if ( e.target.value )
                    {
                        loadUserAttendance( e.target.value );
                    }
                } );
            }

            async function loadUserAttendance ( username )
            {
                const res = await fetch( `/admin/attendance/${ username }` );
                const attendance = await res.json();
                const tbody = document.getElementById( 'attendance-viewer-body' );
                tbody.innerHTML = '';
                if ( attendance.length === 0 )
                {
                    tbody.innerHTML = '<tr><td colspan="8">No attendance records found for this user.</td></tr>';
                    return;
                }
                attendance.forEach( row =>
                {
                    const tr = document.createElement( 'tr' );
                    tr.innerHTML = `
                    <td>${ row.date }</td>
                    <td>${ row.in_time || '' }</td>
                    <td>${ row.in_latitude ? `${ row.in_latitude.toFixed( 4 ) }, ${ row.in_longitude.toFixed( 4 ) }` : '' }</td>
                    <td>${ row.in_selfie_path ? `<img src="${ row.in_selfie_path }" width="100">` : '' }</td>
                    <td>${ row.out_time || '' }</td>
                    <td>${ row.out_latitude ? `${ row.out_latitude.toFixed( 4 ) }, ${ row.out_longitude.toFixed( 4 ) }` : '' }</td>
                    <td>${ row.out_selfie_path ? `<img src="${ row.out_selfie_path }" width="100">` : '' }</td>
                    <td>${ row.total_time || '' }</td>
                `;
                    tbody.appendChild( tr );
                } );
            }
        </script>
    </body>

</html>