<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin Dashboard</title>
        <style>
            body {
                font-family: sans-serif;
                margin: 2em;
            }

            h1,
            h2 {
                color: #333;
            }

            .container {
                max-width: 1200px;
                margin: auto;
            }

            .section {
                background-color: #f4f4f4;
                padding: 1em;
                margin-top: 1em;
                border-radius: 5px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 1em;
            }

            th,
            td {
                padding: 0.5em;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }

            th {
                background-color: #e9e9e9;
            }

            .approve-btn,
            .reject-btn {
                padding: 5px 10px;
                border: none;
                color: white;
                border-radius: 3px;
                cursor: pointer;
            }

            .approve-btn {
                background-color: #28a745;
            }

            .reject-btn {
                background-color: #dc3545;
            }

            .status-pending {
                color: orange;
            }

            .status-approved {
                color: green;
            }

            .status-rejected {
                color: red;
            }
        </style>
    </head>

    <body>
        <div class="container">
            <h1>Admin Dashboard</h1>
            <p>Welcome, <strong id="admin-name"></strong>! (<span id="admin-role"></span>) | <a
                    href="/logout">Logout</a></p>

            <!-- Section for Leave Request Management -->
            <div class="section">
                <h2>Pending Leave Requests</h2>
                <table id="leave-requests-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Reason</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="leave-requests-body"></tbody>
                </table>
            </div>

            <!-- Section for All Leaves History -->
            <div class="section">
                <h2>All Leave Requests</h2>
                <table id="all-leaves-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Reason</th>
                            <th>Status</th>
                            <th>Approved By</th>
                        </tr>
                    </thead>
                    <tbody id="all-leaves-body"></tbody>
                </table>
            </div>

            <!-- Section for Viewing Employee Attendance -->
            <div class="section">
                <h2>View Employee Attendance</h2>
                <label for="user-select">Select Employee:</label>
                <select id="user-select"></select>
                <table id="attendance-viewer-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>In Time</th>
                            <th>In Location</th>
                            <th>In Selfie</th>
                            <th>Out Time</th>
                            <th>Out Location</th>
                            <th>Out Selfie</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-viewer-body"></tbody>
                </table>
            </div>
        </div>

        <script>
            let currentUser;

            window.addEventListener( 'load', async () =>
            {
                // Fetch current admin's info
                const userRes = await fetch( '/user/me' );
                currentUser = await userRes.json();
                document.getElementById( 'admin-name' ).textContent = currentUser.name;
                document.getElementById( 'admin-role' ).textContent = currentUser.role.replace( '_', ' ' );

                // Load all necessary data
                await loadLeaveRequests();
                await loadAllLeaves();
                await populateUserDropdown();
            } );

            // --- LEAVE MANAGEMENT ---
            async function loadLeaveRequests ()
            {
                const res = await fetch( '/admin/leaves' );
                const leaves = await res.json();
                const tbody = document.getElementById( 'leave-requests-body' );
                tbody.innerHTML = '';
                if ( leaves.length === 0 )
                {
                    tbody.innerHTML = '<tr><td colspan="5">No pending leave requests.</td></tr>';
                    return;
                }
                leaves.forEach( leave =>
                {
                    const tr = document.createElement( 'tr' );
                    tr.innerHTML = `
                    <td>${ leave.username }</td>
                    <td>${ leave.start_date }</td>
                    <td>${ leave.end_date }</td>
                    <td>${ leave.reason }</td>
                    <td>
                        <button class="approve-btn" onclick="handleLeaveAction(${ leave.leave_id }, 'approved')">Approve</button>
                        <button class="reject-btn" onclick="handleLeaveAction(${ leave.leave_id }, 'rejected')">Reject</button>
                    </td>
                `;
                    tbody.appendChild( tr );
                } );
            }

            async function loadAllLeaves ()
            {
                const res = await fetch( '/admin/leaves/history' );
                const leaves = await res.json();
                const tbody = document.getElementById( 'all-leaves-body' );
                tbody.innerHTML = '';
                if ( leaves.length === 0 )
                {
                    tbody.innerHTML = '<tr><td colspan="6">No leave requests found.</td></tr>';
                    return;
                }
                leaves.forEach( leave =>
                {
                    const tr = document.createElement( 'tr' );
                    tr.innerHTML = `
                    <td>${ leave.username }</td>
                    <td>${ leave.start_date }</td>
                    <td>${ leave.end_date }</td>
                    <td>${ leave.reason }</td>
                    <td class="status-${ leave.status }">${ leave.status }</td>
                    <td>${ leave.approved_by || '' }</td>
                `;
                    tbody.appendChild( tr );
                } );
            }

            async function handleLeaveAction ( leave_id, status )
            {
                await fetch( '/admin/leaves/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify( { leave_id, status } )
                } );
                loadLeaveRequests(); // Refresh the list
                loadAllLeaves(); // Refresh all leaves list
            }

            // --- ATTENDANCE VIEWER ---
            async function populateUserDropdown ()
            {
                const res = await fetch( '/admin/users' );
                const users = await res.json();
                const select = document.getElementById( 'user-select' );
                select.innerHTML = '<option value="">-- Select an employee --</option>';
                users.forEach( user =>
                {
                    if ( user.role !== 'owner_admin' )
                    { // Owner admin attendance is not tracked
                        const option = document.createElement( 'option' );
                        option.value = user.name;
                        option.textContent = `${ user.name } (${ user.role.replace( '_', ' ' ) })`;
                        select.appendChild( option );
                    }
                } );
                select.addEventListener( 'change', ( e ) =>
                {
                    if ( e.target.value )
                    {
                        loadUserAttendance( e.target.value );
                    }
                } );
            }

            async function loadUserAttendance ( username )
            {
                const res = await fetch( `/admin/attendance/${ username }` );
                const attendance = await res.json();
                const tbody = document.getElementById( 'attendance-viewer-body' );
                tbody.innerHTML = '';
                if ( attendance.length === 0 )
                {
                    tbody.innerHTML = '<tr><td colspan="7">No attendance records found for this user.</td></tr>';
                    return;
                }
                attendance.forEach( row =>
                {
                    const tr = document.createElement( 'tr' );
                    tr.innerHTML = `
                    <td>${ row.date }</td>
                    <td>${ row.in_time || '' }</td>
                    <td>${ row.in_latitude ? `${ row.in_latitude.toFixed( 4 ) }, ${ row.in_longitude.toFixed( 4 ) }` : '' }</td>
                    <td>${ row.in_selfie_path ? `<img src="${ row.in_selfie_path }" width="100">` : '' }</td>
                    <td>${ row.out_time || '' }</td>
                    <td>${ row.out_latitude ? `${ row.out_latitude.toFixed( 4 ) }, ${ row.out_longitude.toFixed( 4 ) }` : '' }</td>
                    <td>${ row.out_selfie_path ? `<img src="${ row.out_selfie_path }" width="100">` : '' }</td>
                `;
                    tbody.appendChild( tr );
                } );
            }
        </script>
    </body>

</html>