<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin Dashboard</title>
        <style>
            body {
                font-family: sans-serif;
                margin: 2em;
            }

            h1,
            h2 {
                color: #333;
            }

            .container {
                max-width: 1200px;
                margin: auto;
            }

            .section {
                background-color: #f4f4f4;
                padding: 1em;
                margin-top: 1em;
                border-radius: 5px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 1em;
            }

            th,
            td {
                padding: 0.5em;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }

            th {
                background-color: #e9e9e9;
            }

            .approve-btn,
            .reject-btn {
                padding: 5px 10px;
                border: none;
                color: white;
                border-radius: 3px;
                cursor: pointer;
            }

            /* Ensure action buttons in tables don't expand to full width (mobile.css sets button width:100%) */
            .approve-btn,
            .reject-btn {
                display: inline-block;
                width: auto;
                padding: 8px 14px;
                font-size: 0.95rem;
                margin-right: 6px;
                box-sizing: border-box;
            }

            .approve-btn {
                background-color: #28a745;
            }

            .reject-btn {
                background-color: #dc3545;
            }

            .status-pending {
                color: orange;
            }

            .status-approved {
                color: green;
            }

            .status-rejected {
                color: red;
            }
        </style>
        <link rel="stylesheet" href="/css/mobile.css">
        <script src="/js/ui.js"></script>
    </head>

    <body>
        <div class="container">
            <h1>Admin Dashboard</h1>
            <p>Welcome, <strong id="admin-name"></strong>! (<span id="admin-role"></span>) <span
                    id="back-link-container"></span> | <a href="/visual">Visual Calendar</a> | <a href="/profile">Change
                    Password</a> | <a href="/logout">Logout</a></p>

            <!-- Owner settings accessible from App Settings -->
            <div class="section" id="test-date-section"
                style="display:none;background:#fff6f6;border:1px solid #ffd6d6">
                <h2>Test Date Override (Owner)</h2>
                <p class="small">Set a permanent test date that the app will treat as "today" for all users. Leave blank
                    to clear.</p>
                <label for="test-date-input">Test Date</label>
                <input type="date" id="test-date-input">
                <button id="set-test-date">Set Test Date</button>
                <button id="clear-test-date">Clear Test Date</button>
                <div id="current-test-date" class="small" style="margin-top:8px"></div>
            </div>

            <!-- Section for Leave Request Management -->
            <div class="section">
                <h2>Pending Leave Requests</h2>
                <div class="table-wrap">
                    <table id="leave-requests-table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Reason</th>
                                <th>Action</th>
                                <th>Flags</th>
                            </tr>
                        </thead>
                        <tbody id="leave-requests-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Section for All Leaves History -->
            <div class="section">
                <h2>All Leave Requests</h2>
                <div class="table-wrap">
                    <table id="all-leaves-table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Actioned By</th>
                            </tr>
                        </thead>
                        <tbody id="all-leaves-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Section for Viewing Employee Attendance -->
            <div class="section">
                <h2>Add New User</h2>
                <form id="add-user-form">
                    <label for="new-username">Username:</label>
                    <input type="text" id="new-username" name="name" required pattern="[A-Za-z0-9_]+">
                    <br><br>
                    <label for="new-password">Password (optional, default 111):</label>
                    <input type="password" id="new-password" name="password" placeholder="111">
                    <br><br>
                    <label for="new-role">Role:</label>
                    <select id="new-role" name="role">
                        <option value="employee">Employee</option>
                        <option value="manager">Manager</option>
                        <option value="owner">Owner</option>
                    </select>
                    <br><br>
                    <button type="submit">Add User</button>
                </form>
                <hr>
                <h2>Reset Passwords</h2>
                <form id="reset-password-form">
                    <label>Reset Target:</label>
                    <br>
                    <select id="reset-target" name="reset_target">
                        <option value="">-- Select a user to reset --</option>
                        <!-- specific users will be appended here -->
                    </select>
                    <br><br>
                    <label for="reset-password">New password (optional, default 111):</label>
                    <input type="password" id="reset-password" name="password" placeholder="111">
                    <br><br>
                    <button type="submit">Reset Password</button>
                </form>
                <hr>
                <h2>View Employee Attendance</h2>
                <label for="user-select">Select Employee:</label>
                <select id="user-select"></select>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>In Time</th>
                                <th>In Location</th>
                                <th>In Selfie</th>
                                <th>Out Time</th>
                                <th>Out Location</th>
                                <th>Out Selfie</th>
                                <th>Total Time</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-viewer-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            let currentUser;

            window.addEventListener( 'load', async () =>
            {
                // Fetch current admin's info
                const userRes = await fetch( '/user/me' );
                currentUser = await userRes.json();
                document.getElementById( 'admin-name' ).textContent = currentUser.name;
                document.getElementById( 'admin-role' ).textContent = currentUser.role.replace( '_', ' ' );

                // Owner gets quick App Settings link
                if ( currentUser && currentUser.role === 'owner' )
                {
                    const container = document.getElementById( 'back-link-container' );
                    if ( container ) container.innerHTML = ' | <a href="/appsettings">App Settings</a>';
                    // show owner-only test-date override section
                    const tsec = document.getElementById( 'test-date-section' );
                    if ( tsec ) tsec.style.display = '';
                }
                else
                {
                    // ensure non-owners (e.g. managers) do not see the test-date section
                    const tsec = document.getElementById( 'test-date-section' );
                    if ( tsec ) tsec.style.display = 'none';
                }

                // Profile link in header
                const header = document.querySelector( 'p' );
                if ( header )
                {
                    // ensure profile link is present without duplicating
                    const profileLink = header.querySelector( 'a[href="/profile"]' );
                    if ( !profileLink )
                    {
                        header.innerHTML = header.innerHTML.replace( '| <a href="/logout">Logout</a>', '| <a href="/profile">Profile</a> | <a href="/logout">Logout</a>' );
                    }
                }

                // Show Back to Dashboard link for managers (they should be able to return to attendance UI)
                if ( currentUser && currentUser.role === 'manager' )
                {
                    const container = document.getElementById( 'back-link-container' );
                    if ( container ) container.innerHTML = ' | <a href="/dashboard">Back to Dashboard</a>';
                }

                // Load all necessary data
                await loadLeaveRequests();
                await loadAllLeaves();
                await populateUserDropdown();
                setupAddUserForm();
            } );



            function setupAddUserForm ()
            {
                const form = document.getElementById( 'add-user-form' );
                const roleSelect = document.getElementById( 'new-role' );
                // If the current admin is a manager, remove owner and manager options
                if ( currentUser && currentUser.role === 'manager' )
                {
                    const ownerOption = roleSelect.querySelector( 'option[value="owner"]' );
                    if ( ownerOption ) ownerOption.remove();
                    const managerOption = roleSelect.querySelector( 'option[value="manager"]' );
                    if ( managerOption ) managerOption.remove();

                    // If only one role (employee) remains, replace the dropdown with a fixed label + hidden input
                    // to avoid showing a useless single-value select to managers.
                    const remainingOptions = Array.from( roleSelect.options ).map( o => o.value );
                    if ( remainingOptions.length === 1 )
                    {
                        const parent = roleSelect.parentNode;
                        const wrapper = document.createElement( 'div' );
                        // keep the existing label ("Role:"), so show only the capitalized role name here
                        wrapper.innerHTML = `<input type="hidden" id="new-role-hidden" name="role" value="${ remainingOptions[ 0 ] }"><span>${ remainingOptions[ 0 ].charAt( 0 ).toUpperCase() + remainingOptions[ 0 ].slice( 1 ) }</span>`;
                        parent.replaceChild( wrapper, roleSelect );
                    }
                }
                form.addEventListener( 'submit', async ( e ) =>
                {
                    e.preventDefault();
                    const name = document.getElementById( 'new-username' ).value.trim();
                    const password = document.getElementById( 'new-password' ).value;
                    const roleEl = document.getElementById( 'new-role' );
                    const hiddenRoleEl = document.getElementById( 'new-role-hidden' );
                    const role = roleEl ? roleEl.value : ( hiddenRoleEl ? hiddenRoleEl.value : 'employee' );

                    try
                    {
                        const res = await fetch( '/admin/users/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify( { name, password, role } )
                        } );
                        const result = await res.json();
                        if ( res.ok && result.success )
                        {
                            showAppModal( 'User created successfully.', 'success' );
                            form.reset();
                            populateUserDropdown();
                        } else
                        {
                            showAppModal( result.message || 'Could not create the user. Please try again.', 'error' );
                        }
                    } catch ( err )
                    {
                        console.error( err );
                        showAppModal( 'An error occurred while creating the user. Please try again.', 'error' );
                    }
                } );

                // --- Test Date Override UI ---
                ( function ()
                {
                    try
                    {
                        // Use the already-fetched `currentUser` to avoid an extra network request
                        if ( !currentUser || currentUser.role !== 'owner' ) return; // only show to owner

                        const info = document.getElementById( 'current-test-date' );
                        function formatDatePretty ( iso )
                        {
                            if ( !iso ) return iso;
                            // Expect iso YYYY-MM-DD -> format to D-MMM-YY (e.g., 4-Dec-25)
                            const parts = iso.split( '-' );
                            if ( parts.length !== 3 ) return iso;
                            const y = parts[ 0 ];
                            const m = parseInt( parts[ 1 ], 10 );
                            const d = parseInt( parts[ 2 ], 10 );
                            const months = [ 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec' ];
                            return `${ d }-${ months[ m - 1 ] }-${ y.slice( 2 ) }`;
                        }
                        const input = document.getElementById( 'test-date-input' );
                        const setBtn = document.getElementById( 'set-test-date' );
                        const clearBtn = document.getElementById( 'clear-test-date' );

                        // fetch current value (owner only)
                        ( async function ()
                        {
                            try
                            {
                                const curRes = await fetch( '/admin/settings/test-date' );
                                if ( curRes.ok )
                                {
                                    const body = await curRes.json();
                                    if ( body && body.test_date )
                                    {
                                        info.textContent = `Current override: ${ formatDatePretty( body.test_date ) }`;
                                        input.value = body.test_date;
                                    } else
                                    {
                                        info.textContent = 'No test date override is set.';
                                    }
                                }
                            } catch ( e ) { /* ignore */ }
                        } )();

                        setBtn.addEventListener( 'click', async () =>
                        {
                            const dt = input.value;
                            try
                            {
                                const res = await fetch( '/admin/settings/test-date', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify( { test_date: dt } ) } );
                                const body = await res.json();
                                if ( res.ok && body.success )
                                {
                                    info.textContent = body.test_date ? `Current override: ${ formatDatePretty( body.test_date ) }` : 'No test date override is set.';
                                    showAppModal( 'Test date override saved.', 'success' );
                                } else
                                {
                                    showAppModal( body.message || 'Could not save test date.', 'error' );
                                }
                            } catch ( e ) { console.error( e ); showAppModal( 'Could not save test date.', 'error' ); }
                        } );

                        clearBtn.addEventListener( 'click', async () =>
                        {
                            try
                            {
                                const res = await fetch( '/admin/settings/test-date', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify( { test_date: '' } ) } );
                                const body = await res.json();
                                if ( res.ok && body.success )
                                {
                                    info.textContent = 'No test date override is set.';
                                    input.value = '';
                                    showAppModal( 'Test date override cleared.', 'success' );
                                } else
                                {
                                    showAppModal( body.message || 'Could not clear test date.', 'error' );
                                }
                            } catch ( e ) { console.error( e ); showAppModal( 'Could not clear test date.', 'error' ); }
                        } );

                    } catch ( e ) { /* ignore */ }
                } )();

                // Reset passwords handler
                const resetForm = document.getElementById( 'reset-password-form' );
                resetForm.addEventListener( 'submit', async ( e ) =>
                {
                    e.preventDefault();
                    const password = document.getElementById( 'reset-password' ).value;
                    const target = document.getElementById( 'reset-target' ).value;

                    if ( !target )
                    {
                        showAppModal( 'Please choose a user to reset.', 'error' );
                        return;
                    }

                    try
                    {
                        const res = await fetch( '/admin/users/reset-password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify( { username: target, password } )
                        } );
                        const result = await res.json();
                        if ( res.ok && result.success )
                        {
                            showAppModal( result.message, 'success' );
                        } else
                        {
                            showAppModal( result.message || 'Failed to reset the user\'s password. Please try again.', 'error' );
                        }
                    } catch ( err )
                    {
                        console.error( err );
                        showAppModal( 'We could not reset the password right now. Please try again.', 'error' );
                    }
                } );


            }


            // --- LEAVE MANAGEMENT ---
            async function loadLeaveRequests ()
            {
                const res = await fetch( '/admin/leaves' );
                const leaves = await res.json();
                const tbody = document.getElementById( 'leave-requests-body' );
                tbody.innerHTML = '';
                if ( leaves.length === 0 )
                {
                    tbody.innerHTML = '<tr><td colspan="5">No pending leave requests.</td></tr>';
                    return;
                }
                leaves.forEach( leave =>
                {
                    const tr = document.createElement( 'tr' );
                    const reasonPreview = leave.reason_truncated || ( leave.reason || '' );
                    const fullReason = leave.reason_full || ( leave.reason || '' );
                    // Remove server-provided ellipsis if present, so only one '...' link appears
                    let previewForDisplay = reasonPreview;
                    if ( previewForDisplay && previewForDisplay.endsWith( '...' ) ) previewForDisplay = previewForDisplay.slice( 0, -3 );
                    const reasonHtml = fullReason && fullReason.length > 25
                        ? `${ escapeHtml( previewForDisplay ) } <a href="#" class="show-reason" data-full="${ escapeHtmlAttr( fullReason ) }">...</a>`
                        : escapeHtml( previewForDisplay );

                    const flags = [];
                    if ( leave.is_backdated ) flags.push( '<span title="Backdated request" style="font-size:12px;color:#666;margin-right:6px;">(backdated)</span>' );
                    if ( leave.taken_back && leave.status !== 'withdrawn' ) flags.push( '<span title="Taken back" style="font-size:12px;color:#999;margin-right:6px;">(withdrawn)</span>' );

                    // Determine whether current admin can act on this leave
                    let actionHtml = '';
                    const isPending = ( leave.status === 'pending' );
                    const isWithdrawn = !!leave.taken_back;
                    // currentUser is available globally; manager can act only on employee leaves
                    const adminRole = ( currentUser && currentUser.role ) ? currentUser.role : '';
                    const managerRestricted = ( adminRole === 'manager' && leave.role !== 'employee' );
                    const canAct = isPending && !isWithdrawn && !managerRestricted;
                    if ( canAct )
                    {
                        actionHtml = `<button class="approve-btn" onclick="handleLeaveAction(${ leave.leave_id }, 'approved')">Approve</button> <button class="reject-btn" onclick="handleLeaveAction(${ leave.leave_id }, 'rejected')">Reject</button>`;
                    }

                    tr.innerHTML = `
                    <td>${ leave.username }</td>
                    <td>${ leave.start_date }</td>
                    <td>${ leave.end_date }</td>
                    <td>${ reasonHtml }</td>
                    <td>${ actionHtml }</td>
                    <td>${ flags.join( ' ' ) }</td>
                `;
                    tbody.appendChild( tr );
                } );
            }

            async function loadAllLeaves ()
            {
                const res = await fetch( '/admin/leaves/history' );
                const leaves = await res.json();
                const tbody = document.getElementById( 'all-leaves-body' );
                tbody.innerHTML = '';
                if ( leaves.length === 0 )
                {
                    tbody.innerHTML = '<tr><td colspan="6">No leave requests found.</td></tr>';
                    return;
                }
                leaves.forEach( leave =>
                {
                    const tr = document.createElement( 'tr' );
                    const reasonPreview = leave.reason_truncated || ( leave.reason || '' );
                    const fullReason = leave.reason_full || ( leave.reason || '' );
                    const reasonHtml = fullReason && fullReason.length > 25
                        ? `${ escapeHtml( reasonPreview ) } <a href="#" class="show-reason" data-full="${ escapeHtmlAttr( fullReason ) }">...</a>`
                        : escapeHtml( reasonPreview );

                    const flags = [];
                    if ( leave.is_backdated ) flags.push( '<span title="Backdated request" style="font-size:12px;color:#666;margin-right:6px;">(backdated)</span>' );
                    if ( leave.taken_back && leave.status !== 'withdrawn' ) flags.push( '<span title="Taken back" style="font-size:12px;color:#999;margin-right:6px;">(withdrawn)</span>' );
                    tr.innerHTML = `
                    <td>${ leave.username }</td>
                    <td>${ leave.start_date }</td>
                    <td>${ leave.end_date }</td>
                    <td>${ reasonHtml }</td>
                    <td class="status-${ leave.status }">${ leave.status } ${ flags.join( ' ' ) }</td>
                    <td>${ leave.approved_by || '' }</td>
                `;
                    tbody.appendChild( tr );
                } );
            }


            // Simple HTML escaping helpers
            function escapeHtml ( str )
            {
                if ( !str ) return '';
                return str.replace( /&/g, '&amp;' ).replace( /</g, '&lt;' ).replace( />/g, '&gt;' ).replace( /"/g, '&quot;' ).replace( /'/g, '&#39;' );
            }

            function escapeHtmlAttr ( str )
            {
                return escapeHtml( str ).replace( /"/g, '&quot;' );
            }

            // Delegate click for show-reason links (use shared showAppModal)
            document.addEventListener( 'click', ( e ) =>
            {
                const target = e.target;
                if ( target && target.classList && target.classList.contains( 'show-reason' ) )
                {
                    e.preventDefault();
                    const full = target.getAttribute( 'data-full' ) || '';
                    if ( window.showAppModal ) window.showAppModal( full, 'info' );
                }
            } );
            async function handleLeaveAction ( leave_id, status )
            {
                try
                {
                    const res = await fetch( '/admin/leaves/action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify( { leave_id, status } )
                    } );
                    if ( res.ok )
                    {
                        const msg = status === 'approved' ? 'Leave approved successfully.' : 'Leave rejected successfully.';
                        if ( window.showAppModal ) window.showAppModal( msg, 'success' );
                    } else
                    {
                        // Try to extract error message
                        let text = 'Could not process the action.';
                        try { text = await res.text(); } catch ( e ) { /* ignore */ }
                        if ( window.showAppModal ) window.showAppModal( text || 'Could not process the action.', 'error' );
                    }
                } catch ( e )
                {
                    console.error( e );
                    if ( window.showAppModal ) window.showAppModal( 'An unexpected error occurred while processing the leave action.', 'error' );
                }

                // Refresh lists in either case to reflect updated server state
                loadLeaveRequests(); // Refresh the list
                loadAllLeaves(); // Refresh all leaves list
            }

            // --- ATTENDANCE VIEWER ---
            async function populateUserDropdown ()
            {
                const res = await fetch( '/admin/users' );
                const users = await res.json();
                const select = document.getElementById( 'user-select' );
                select.innerHTML = '<option value="">-- Select an employee --</option>';
                const resetSelect = document.getElementById( 'reset-target' );
                // clear existing options
                if ( resetSelect )
                {
                    resetSelect.innerHTML = '<option value="">-- Select a user to reset --</option>';
                }
                users.forEach( user =>
                {
                    if ( user.role !== 'owner' )
                    { // Owner attendance is not tracked
                        const option = document.createElement( 'option' );
                        option.value = user.name;
                        option.textContent = `${ user.name } (${ user.role.replace( '_', ' ' ) })`;
                        select.appendChild( option );
                    }

                    // Add to reset-target select for specific user reset
                    if ( resetSelect )
                    {
                        // owner_admin sees all users; employee_admin sees employee_admin and employee; never include other users beyond those
                        if ( currentUser && currentUser.role === 'owner' )
                        {
                            const rOpt = document.createElement( 'option' );
                            rOpt.value = user.name;
                            rOpt.textContent = `${ user.name } (${ user.role.replace( '_', ' ' ) })`;
                            resetSelect.appendChild( rOpt );
                        } else if ( currentUser && currentUser.role === 'manager' )
                        {
                            // Manager can reset only regular employees
                            if ( user.role === 'employee' )
                            {
                                const rOpt = document.createElement( 'option' );
                                rOpt.value = user.name;
                                rOpt.textContent = `${ user.name } (${ user.role.replace( '_', ' ' ) })`;
                                resetSelect.appendChild( rOpt );
                            }
                        }
                    }
                } );
                select.addEventListener( 'change', ( e ) =>
                {
                    if ( e.target.value )
                    {
                        loadUserAttendance( e.target.value );
                    }
                } );
            }

            async function loadUserAttendance ( username )
            {
                const res = await fetch( `/admin/attendance/${ username }` );
                const attendance = await res.json();
                const tbody = document.getElementById( 'attendance-viewer-body' );
                tbody.innerHTML = '';
                if ( attendance.length === 0 )
                {
                    tbody.innerHTML = '<tr><td colspan="8">No attendance records found for this user.</td></tr>';
                    return;
                }
                attendance.forEach( row =>
                {
                    const tr = document.createElement( 'tr' );
                    tr.innerHTML = `
                    <td>${ row.date }</td>
                    <td>${ row.in_time || '' }</td>
                    <td>${ row.in_latitude ? `<a href="https://www.google.com/maps/search/?api=1&query=${ row.in_latitude },${ row.in_longitude }" target="_blank" rel="noopener noreferrer">${ row.in_latitude.toFixed( 4 ) }, ${ row.in_longitude.toFixed( 4 ) }</a>` : '' }</td>
                    <td>${ row.in_selfie_path ? `<img src="${ row.in_selfie_path }" width="100">` : '' }</td>
                    <td>${ row.out_time || '' }</td>
                    <td>${ row.out_latitude ? `<a href="https://www.google.com/maps/search/?api=1&query=${ row.out_latitude },${ row.out_longitude }" target="_blank" rel="noopener noreferrer">${ row.out_latitude.toFixed( 4 ) }, ${ row.out_longitude.toFixed( 4 ) }</a>` : '' }</td>
                    <td>${ row.out_selfie_path ? `<img src="${ row.out_selfie_path }" width="100">` : '' }</td>
                    <td>${ row.total_time || '' }</td>
                `;
                    tbody.appendChild( tr );
                } );
            }
        </script>
        <!-- Desktop access toggle removed from admin page. Use App Settings instead. -->
    </body>

</html>