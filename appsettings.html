<!doctype html>
<html>

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>App Settings</title>
        <link rel="stylesheet" href="/css/mobile.css">
        <link rel="stylesheet" href="/css/flatpickr.min.css">
        <link rel="stylesheet" href="/css/airbnb.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


    </head>

    <body>
        <div class="container">
            <h1><i class="fas fa-cog"></i> System Settings</h1>
            <p>Manage your attendance system.</p>

            <div class="section">
                <h2><i class="fas fa-desktop"></i> Desktop Access Control</h2>
                <label style="display:inline-flex;align-items:center;gap:8px">
                    <input type="checkbox" id="desktop-enabled"> <span>Let team members sign in from desktops</span>
                </label>
                <div style="margin-top:8px" class="small">When disabled, your team can only access from mobile devices.
                </div>
            </div>

            <div class="section">
                <h2><i class="fas fa-calendar-week"></i> Weekly Holidays</h2>
                <select id="weekly-off-mode">
                    <option value="1">All Sundays off (default)</option>
                    <option value="2">All Sundays + All Saturdays off</option>
                    <option value="3">All Sundays + 2nd & 4th Saturdays off</option>
                </select>
                <div class="small" style="margin-top:8px">Select which days your team gets off each week.</div>
                <div style="margin-top:8px"><button id="save-weekly"><i class="fas fa-save"></i> Save Schedule</button>
                </div>
            </div>

            <div class="section" id="test-date-section" style="background:#fff6f6;border:1px solid #ffd6d6;">
                <h2><i class="fas fa-flask"></i> Testing Mode</h2>
                <p class="small">Simulate a different date for testing. This affects everyone in the system.</p>
                <label for="test-date-input">Test Date</label>
                <input type="date" id="test-date-input">
                <button id="set-test-date"><i class="fas fa-flask"></i> Enable Testing</button>
                <button id="clear-test-date" style="margin-top:8px"><i class="fas fa-redo"></i> Back to Normal</button>
                <div id="current-test-date" class="small" style="margin-top:8px"></div>
            </div>

            <div class="section">
                <h2><i class="fas fa-umbrella-beach"></i> Special Days Off</h2>
                <form id="add-adhoc-form">
                    <label for="adhoc-date"><i class="fas fa-calendar-day"></i> Date</label>
                    <input type="date" id="adhoc-date" name="date" required>
                    <label for="adhoc-reason"><i class="fas fa-comment"></i> Reason</label>
                    <input type="text" id="adhoc-reason" maxlength="250" required>
                    <div style="margin-top:8px"><button type="submit"><i class="fas fa-plus-circle"></i> Add Day
                            Off</button></div>
                </form>
                <hr>
                <div id="adhoc-list">
                    <p><i class="fas fa-spinner fa-spin"></i> Loading special days off...</p>
                </div>
                <div class="small" style="margin-top:8px">Note: Add these at least one day in advance.</div>
            </div>

            <div class="section" style="margin-top:16px">
                <h2><i class="fas fa-gift"></i> Company Holidays</h2>
                <form id="add-holiday-form">
                    <label for="holiday-date"><i class="fas fa-calendar-day"></i> Date</label>
                    <input type="date" id="holiday-date" name="date" required>
                    <label for="holiday-name"><i class="fas fa-star"></i> Holiday Name (e.g. Deepawali)</label>
                    <input type="text" id="holiday-name" name="name" required>
                    <label style="display:inline-flex;align-items:center;gap:8px;margin-top:6px"><input type="checkbox"
                            id="holiday-recurring"> <span>Repeat this holiday every year</span></label>
                    <div style="margin-top:8px"><button type="submit"><i class="fas fa-plus-circle"></i> Add
                            Holiday</button></div>
                </form>
                <hr>
                <div id="holiday-list">
                    <p><i class="fas fa-spinner fa-spin"></i> Loading holidays...</p>
                </div>
                <div class="small" style="margin-top:8px">Add one-time events or holidays that repeat annually.
                </div>
            </div>

            <script>
                async function fetchSettings ()
                {
                    const res = await fetch( '/admin/settings/app' );
                    if ( !res.ok ) { showAppModal( 'Could not load app settings.', 'error' ); return null; }
                    return res.json();
                }

                function formatDatePretty ( iso )
                {
                    if ( !iso ) return iso;
                    // Expect iso YYYY-MM-DD -> format to D-MMM-YY (e.g., 4-Dec-25)
                    const parts = iso.split( '-' );
                    if ( parts.length !== 3 ) return iso;
                    const y = parts[ 0 ];
                    const m = parseInt( parts[ 1 ], 10 );
                    const d = parseInt( parts[ 2 ], 10 );
                    const months = [ 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec' ];
                    return `${ d }-${ months[ m - 1 ] }-${ y.slice( 2 ) }`;
                }

                function formatMonthDayPretty ( mmdd )
                {
                    if ( !mmdd ) return mmdd;
                    const parts = mmdd.split( '-' );
                    if ( parts.length !== 2 ) return mmdd;
                    const m = parseInt( parts[ 0 ], 10 );
                    const d = parseInt( parts[ 1 ], 10 );
                    const months = [ 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec' ];
                    return `${ d }-${ months[ m - 1 ] }`;
                }

                window.addEventListener( 'load', async () =>
                {
                    const s = await fetchSettings();
                    if ( !s ) return;
                    document.getElementById( 'desktop-enabled' ).checked = !!s.desktop_enabled;
                    document.getElementById( 'weekly-off-mode' ).value = s.weekly_off_mode || '1';

                    // Immediate save when desktop access checkbox is toggled
                    const desktopCheckbox = document.getElementById( 'desktop-enabled' );
                    desktopCheckbox.addEventListener( 'change', async () =>
                    {
                        const enabled = desktopCheckbox.checked ? '1' : '0';
                        try
                        {
                            const res = await fetch( '/admin/settings/app', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify( { desktop_enabled: enabled, weekly_off_mode: document.getElementById( 'weekly-off-mode' ).value || '1' } ) } );
                            const body = await res.json();
                            if ( res.ok && body.success )
                            {
                                showAppModal( desktopCheckbox.checked ? 'Desktop access enabled.' : 'Desktop access disabled.', 'success' );
                            } else
                            {
                                showAppModal( body.message || 'Could not update desktop access setting.', 'error' );
                                desktopCheckbox.checked = !desktopCheckbox.checked; // revert
                            }
                        } catch ( e )
                        {
                            console.error( e );
                            showAppModal( 'Failed to update desktop access. Please try again.', 'error' );
                            desktopCheckbox.checked = !desktopCheckbox.checked; // revert
                        }
                    } );

                    // Test Date Override handlers (owner-only page)
                    try
                    {
                        const info = document.getElementById( 'current-test-date' );
                        const input = document.getElementById( 'test-date-input' );
                        const setBtn = document.getElementById( 'set-test-date' );
                        const clearBtn = document.getElementById( 'clear-test-date' );

                        // Load current test-date override
                        ( async function ()
                        {
                            try
                            {
                                const curRes = await fetch( '/admin/settings/test-date' );
                                if ( curRes.ok )
                                {
                                    const body = await curRes.json();
                                    if ( body && body.test_date )
                                    {
                                        info.textContent = `Current override: ${ formatDatePretty( body.test_date ) }`;
                                        input.value = body.test_date;
                                    } else
                                    {
                                        info.textContent = 'No test date override is set.';
                                    }
                                }
                            } catch ( e ) { /* ignore */ }
                        } )();

                        setBtn.addEventListener( 'click', async () =>
                        {
                            const dt = input.value;
                            try
                            {
                                const res = await fetch( '/admin/settings/test-date', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify( { test_date: dt } ) } );
                                const body = await res.json();
                                if ( res.ok && body.success )
                                {
                                    info.textContent = body.test_date ? `Current override: ${ formatDatePretty( body.test_date ) }` : 'No test date override is set.';
                                    showAppModal( 'Test date override saved.', 'success' );
                                } else
                                {
                                    showAppModal( body.message || 'Could not save test date.', 'error' );
                                }
                            } catch ( e ) { console.error( e ); showAppModal( 'Could not save test date.', 'error' ); }
                        } );

                        clearBtn.addEventListener( 'click', async () =>
                        {
                            try
                            {
                                const res = await fetch( '/admin/settings/test-date', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify( { test_date: '' } ) } );
                                const body = await res.json();
                                if ( res.ok && body.success )
                                {
                                    info.textContent = 'No test date override is set.';
                                    input.value = '';
                                    showAppModal( 'Test date override cleared.', 'success' );
                                } else
                                {
                                    showAppModal( body.message || 'Could not clear test date.', 'error' );
                                }
                            } catch ( e ) { console.error( e ); showAppModal( 'Could not clear test date.', 'error' ); }
                        } );
                    } catch ( e ) { /* ignore */ }

                    // Ad-hoc list
                    const adhocList = document.getElementById( 'adhoc-list' );
                    if ( s.ad_hoc_offs && s.ad_hoc_offs.length )
                    {
                        adhocList.innerHTML = '';
                        s.ad_hoc_offs.forEach( a =>
                        {
                            const row = document.createElement( 'div' );
                            row.className = 'card list-row';
                            row.innerHTML = `<div>${ formatDatePretty( a.date ) } — ${ a.reason || '' }</div><div style="text-align:right"><button data-id="${ a.id }" class="remove-adhoc" title="Remove" style="padding:6px 10px;min-width:auto;background:#f44336;border-color:#f44336"><i class="fas fa-trash"></i></button></div>`;
                            adhocList.appendChild( row );
                        } );
                    } else
                    {
                        adhocList.innerHTML = '<p>No ad-hoc off days declared.</p>';
                    }

                    // Holidays
                    const holList = document.getElementById( 'holiday-list' );
                    if ( s.holidays && s.holidays.length )
                    {
                        holList.innerHTML = '';
                        s.holidays.forEach( h =>
                        {
                            const row = document.createElement( 'div' );
                            row.className = 'card list-row';
                            let display = '';
                            if ( h.date ) display = `${ formatDatePretty( h.date ) }`;
                            else if ( h.month_day ) display = `${ formatMonthDayPretty( h.month_day ) } (recurring)`;
                            else display = 'Unknown date';
                            row.innerHTML = `<div>${ display } — ${ h.name }</div><div style="text-align:right"><button data-id="${ h.id }" class="remove-holiday" title="Remove" style="padding:6px 10px;min-width:auto;background:#f44336;border-color:#f44336"><i class="fas fa-trash"></i></button></div>`;
                            holList.appendChild( row );
                        } );
                    } else
                    {
                        holList.innerHTML = '<p>No holidays configured.</p>';
                    }

                    // Wire up remove buttons
                    document.querySelectorAll( '.remove-adhoc' ).forEach( btn =>
                    {
                        btn.addEventListener( 'click', async ( e ) =>
                        {
                            const id = btn.getAttribute( 'data-id' );
                            const ok = await showAppConfirm( 'Remove this ad-hoc off day?' );
                            if ( !ok ) return;
                            try
                            {
                                const res = await fetch( '/admin/settings/app/ad-hoc/remove', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify( { id } ) } );
                                const body = await res.json();
                                if ( res.ok && body.success ) { showAppModal( 'Removed.', 'success', () => window.location.reload() ); }
                                else showAppModal( body.message || 'Failed to remove.', 'error' );
                            } catch ( e ) { console.error( e ); showAppModal( 'Failed to remove.', 'error' ); }
                        } );
                    } );

                    document.querySelectorAll( '.remove-holiday' ).forEach( btn =>
                    {
                        btn.addEventListener( 'click', async ( e ) =>
                        {
                            const id = btn.getAttribute( 'data-id' );
                            const ok = await showAppConfirm( 'Remove this holiday?' );
                            if ( !ok ) return;
                            try
                            {
                                const res = await fetch( '/admin/settings/app/holidays/remove', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify( { id } ) } );
                                const body = await res.json();
                                if ( res.ok && body.success ) { showAppModal( 'Removed.', 'success', () => window.location.reload() ); }
                                else showAppModal( body.message || 'Failed to remove.', 'error' );
                            } catch ( e ) { console.error( e ); showAppModal( 'Failed to remove.', 'error' ); }
                        } );
                    } );

                    // Save weekly
                    document.getElementById( 'save-weekly' ).addEventListener( 'click', async () =>
                    {
                        const mode = document.getElementById( 'weekly-off-mode' ).value;
                        const enabled = document.getElementById( 'desktop-enabled' ).checked ? '1' : '0';
                        try
                        {
                            const res = await fetch( '/admin/settings/app', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify( { weekly_off_mode: mode, desktop_enabled: enabled } ) } );
                            const body = await res.json();
                            if ( res.ok && body.success ) showAppModal( 'Settings saved.', 'success' ); else showAppModal( body.message || 'Could not save.', 'error' );
                        } catch ( e ) { console.error( e ); showAppModal( 'Could not save settings.', 'error' ); }
                    } );

                    // Add adhoc
                    document.getElementById( 'add-adhoc-form' ).addEventListener( 'submit', async ( e ) =>
                    {
                        e.preventDefault();
                        const date = document.getElementById( 'adhoc-date' ).value;
                        const reason = document.getElementById( 'adhoc-reason' ).value;
                        try
                        {
                            const res = await fetch( '/admin/settings/app/ad-hoc/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify( { date, reason } ) } );
                            const body = await res.json();
                            if ( res.ok && body.success ) { showAppModal( 'Ad-hoc off added.', 'success', () => window.location.reload() ); }
                            else showAppModal( body.message || 'Could not add ad-hoc off.', 'error' );
                        } catch ( e ) { console.error( e ); showAppModal( 'Could not add ad-hoc off.', 'error' ); }
                    } );

                    // Add holiday
                    document.getElementById( 'add-holiday-form' ).addEventListener( 'submit', async ( e ) =>
                    {
                        e.preventDefault();
                        const name = document.getElementById( 'holiday-name' ).value;
                        const dateVal = document.getElementById( 'holiday-date' ).value;
                        const recurring = document.getElementById( 'holiday-recurring' ).checked;
                        try
                        {
                            let payload = { name };
                            if ( recurring )
                            {
                                if ( !dateVal ) { showAppModal( 'Please select a date for the recurring holiday.', 'error' ); return; }
                                const mm = dateVal.slice( 5, 7 );
                                const dd = dateVal.slice( 8, 10 );
                                payload.month_day = `${ mm }-${ dd }`;
                            } else
                            {
                                if ( !dateVal ) { showAppModal( 'Please select a full date for the holiday.', 'error' ); return; }
                                payload.date = dateVal;
                            }
                            const res = await fetch( '/admin/settings/app/holidays/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify( payload ) } );
                            const body = await res.json();
                            if ( res.ok && body.success ) { showAppModal( 'Holiday added.', 'success', () => window.location.reload() ); }
                            else showAppModal( body.message || 'Could not add holiday.', 'error' );
                        } catch ( e ) { console.error( e ); showAppModal( 'Could not add holiday.', 'error' ); }
                    } );

                } );
            </script>
            <script src="/js/ui.js"></script>
            <script src="/js/flatpickr.min.js"></script>
            <script src="/js/bottom-nav.js"></script>
            <script>
                window.addEventListener( 'load', () =>
                {
                    // App settings is owner-only, so always use 'owner' role
                    initBottomNav( 'appsettings', 'owner' );
                } );
            </script>
    </body>

</html>