<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Profile</title>
        <link rel="stylesheet" href="/css/mobile.css">
        <script src="/js/ui.js"></script>
        <style>
            /* Use global mobile.css for layout. Keep only small tweaks when needed. */
            .container {
                max-width: 420px;
            }

            /* modal sizing controlled by global stylesheet */
        </style>
    </head>

    <body>
        <div class="container">
            <h1>Profile</h1>
            <p>Welcome, <strong id="profile-name"></strong>! (<span id="profile-role"></span>) | <a id="back-link"
                    href="/dashboard">Back</a> | <a href="/logout">Logout</a></p>

            <div class="section">
                <h2>Change Password</h2>
                <form id="profile-change-password-form">
                    <label for="current-password">Current password:</label>
                    <input type="password" id="current-password" name="old_password" required>
                    <br><br>
                    <label for="new-password">New password:</label>
                    <input type="password" id="new-password" name="new_password" required>
                    <br><br>
                    <label for="confirm-new-password">Confirm new password:</label>
                    <input type="password" id="confirm-new-password" name="confirm_new_password" required>
                    <br><br>
                    <button type="submit">Change Password</button>
                </form>
            </div>

            <div class="section">
                <h2>Account Info</h2>
                <p><strong>Username:</strong> <span id="info-username"></span></p>
                <p><strong>Role:</strong> <span id="info-role"></span></p>
            </div>
        </div>

        <script>
            async function fetchUser ()
            {
                const res = await fetch( '/user/me' );
                if ( !res.ok ) return null;
                return res.json();
            }

            window.addEventListener( 'load', async () =>
            {
                const user = await fetchUser();
                if ( !user ) { if ( window.showAppModal ) showAppModal( 'Could not load profile. Please login again.', 'error' ); return; }
                document.getElementById( 'profile-name' ).textContent = user.name;
                document.getElementById( 'profile-role' ).textContent = ( user.role || '' ).replace( '_', ' ' );
                document.getElementById( 'info-username' ).textContent = user.name;
                document.getElementById( 'info-role' ).textContent = ( user.role || '' ).replace( '_', ' ' );

                // Back link: admins and others use unified /dashboard
                const back = document.getElementById( 'back-link' );
                back.href = '/dashboard';
            } );

            // Change password handler using shared modal
            document.getElementById( 'profile-change-password-form' ).addEventListener( 'submit', async ( e ) =>
            {
                e.preventDefault();
                const old_password = document.getElementById( 'current-password' ).value;
                const new_password = document.getElementById( 'new-password' ).value;
                const confirm = document.getElementById( 'confirm-new-password' ).value;
                if ( new_password !== confirm ) { if ( window.showAppModal ) showAppModal( 'New passwords do not match.', 'error' ); return; }
                try
                {
                    const res = await fetch( '/user/change-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify( { old_password, new_password } )
                    } );
                    const result = await res.json();
                    if ( res.ok && result.success ) { if ( window.showAppModal ) showAppModal( result.message || 'Password changed.', 'success' ); document.getElementById( 'profile-change-password-form' ).reset(); }
                    else { if ( window.showAppModal ) showAppModal( result.message || 'Failed to change password.', 'error' ); }
                } catch ( err )
                {
                    console.error( err );
                    if ( window.showAppModal ) showAppModal( 'Error changing password.', 'error' );
                }
            } );
        </script>
    </body>

</html>