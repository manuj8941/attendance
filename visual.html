<!doctype html>
<html>

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Visual Calendar</title>
        <link rel="stylesheet" href="/css/mobile.css">
        <script src="/js/ui.js"></script>
    </head>

    <body>
        <div class="container">
            <div class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <h1>My Calendar</h1>
                    <a href="/dashboard" style="font-size:0.9rem">Back</a>
                </div>

                <div class="calendar-controls">
                    <div style="display:flex;gap:4px;align-items:center">
                        <button id="prev-month" class="nav-btn">◀</button>
                        <button id="next-month" class="nav-btn">▶</button>
                        <strong id="month-label" style="margin-left:4px;font-size:1rem"></strong>
                    </div>
                    <div>
                        <button id="today-btn" class="nav-btn">Today</button>
                    </div>
                </div>

                <div id="user-select-container" style="margin-bottom:12px;display:none">
                    <select id="user-select"></select>
                </div>

                <div class="calendar-header">
                    <div>Mon</div>
                    <div>Tue</div>
                    <div>Wed</div>
                    <div>Thu</div>
                    <div>Fri</div>
                    <div>Sat</div>
                    <div>Sun</div>
                </div>

                <div id="calendar" class="calendar-grid"></div>
                <div id="calendar-loading" style="display:none;text-align:center;padding:20px;color:#666">Loading...
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-dot cal-status-present"></div> Present
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot cal-status-absent"></div> Absent
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot cal-status-leave"></div> Leave
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot cal-status-holiday"></div> Holiday
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot cal-status-weekly"></div> Weekly Off
                    </div>
                    <div class="legend-item">
                        <div class="legend-item">
                            <div class="legend-item">
                                <div class="legend-dot cal-status-ad_hoc"></div> Ad-hoc
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                let cur = new Date();
                let selUser = null;

                function pad ( n ) { return n < 10 ? '0' + n : '' + n; }

                // Fetch list of users (only works for admins/managers)
                async function fetchUsersIfAllowed ()
                {
                    try
                    {
                        const res = await fetch( '/admin/users' );
                        if ( !res.ok ) return null;
                        return await res.json();
                    } catch ( e ) { return null; }
                }

                function setMonthLabel ( dt )
                {
                    const months = [ 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December' ];
                    document.getElementById( 'month-label' ).textContent = months[ dt.getMonth() ] + ' ' + dt.getFullYear();
                }

                // Helper to format nice date for modal title
                function formatDateFriendly ( iso )
                {
                    if ( !iso ) return '';
                    const d = new Date( iso );
                    return d.toLocaleDateString( 'en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' } );
                }

                async function loadCalendar ()
                {
                    const year = cur.getFullYear();
                    const month = cur.getMonth() + 1;
                    const username = selUser || '';

                    const loadingEl = document.getElementById( 'calendar-loading' );
                    const container = document.getElementById( 'calendar' );

                    loadingEl.style.display = 'block';
                    container.style.display = 'none';

                    try
                    {
                        const res = await fetch( `/visual/data?username=${ encodeURIComponent( username ) }&year=${ year }&month=${ month }` );
                        if ( !res.ok ) throw new Error( 'Failed to load' );

                        const payload = await res.json();
                        renderCalendar( payload.days, payload.year, payload.month );

                        container.style.display = 'grid';
                    } catch ( e )
                    {
                        console.error( e );
                        // Use global modal if available, else alert
                        if ( window.showAppModal ) showAppModal( 'Could not load calendar data.', 'error' );
                    } finally
                    {
                        loadingEl.style.display = 'none';
                    }
                }

                function renderCalendar ( days, year, month )
                {
                    setMonthLabel( new Date( year, month - 1, 1 ) );
                    const cal = document.getElementById( 'calendar' );
                    cal.innerHTML = '';

                    const first = new Date( year, month - 1, 1 );
                    // Calculate blank days (Monday start: Mon=1...Sun=0 adjustment)
                    let startDow = first.getDay();
                    if ( startDow === 0 ) startDow = 7; // Convert Sun(0) to 7
                    startDow -= 1; // Now Mon=0, Sun=6

                    const daysInMonth = new Date( year, month, 0 ).getDate();

                    // 1. Render blank slots
                    for ( let i = 0; i < startDow; i++ )
                    {
                        const el = document.createElement( 'div' );
                        el.className = 'cal-day empty';
                        cal.appendChild( el );
                    }

                    // 2. Render actual days
                    for ( let d = 1; d <= daysInMonth; d++ )
                    {
                        const dateStr = `${ year }-${ pad( month ) }-${ pad( d ) }`;
                        // Find status for this day
                        const info = days.find( x => x.date === dateStr ) || { date: dateStr, status: 'absent' };

                        const el = document.createElement( 'div' );
                        el.className = `cal-day cal-status-${ info.status }`;
                        el.textContent = d; // Just the number, clean and simple

                        // Interaction
                        el.addEventListener( 'click', () =>
                        {
                            const title = formatDateFriendly( dateStr );
                            const body = [];

                            // Build details list
                            const statusPretty = info.status.charAt( 0 ).toUpperCase() + info.status.slice( 1 ).replace( '_', ' ' );
                            body.push( `<strong>Status:</strong> ${ statusPretty }` );

                            if ( info.in_time ) body.push( `<strong>In:</strong> ${ info.in_time }` );
                            if ( info.out_time ) body.push( `<strong>Out:</strong> ${ info.out_time }` );
                            if ( info.total_time ) body.push( `<strong>Total:</strong> ${ info.total_time }` );

                            if ( info.leave ) body.push( `<strong>Leave Reason:</strong> ${ info.leave.reason || 'N/A' }` );
                            if ( info.holiday_name ) body.push( `<strong>Holiday:</strong> ${ info.holiday_name }` );
                            if ( info.adhoc_reason ) body.push( `<strong>Note:</strong> ${ info.adhoc_reason }` );

                            // Use global modal
                            if ( window.showAppModal )
                            {
                                // We can pass HTML to the modal if we join with <br>
                                // But our basic modal expects text. Let's format it simply for now.
                                // If you want HTML support, we'd update ui.js, but newline works for basic alerts.
                                showAppModal( `${ title }\n\n${ body.map( l => l.replace( /<strong>|<\/strong>/g, '' ) ).join( '\n' ) }`, 'info' );
                            }
                        } );

                        cal.appendChild( el );
                    }
                }

                window.addEventListener( 'load', async () =>
                {
                    // Determine current user
                    const meRes = await fetch( '/user/me' );
                    if ( meRes.ok )
                    {
                        const me = await meRes.json();
                        selUser = me.name;
                    }

                    // Setup User Selector (Manager/Owner only)
                    const users = await fetchUsersIfAllowed();
                    const selContainer = document.getElementById( 'user-select-container' );
                    const sel = document.getElementById( 'user-select' );

                    if ( users && Array.isArray( users ) && users.length > 0 )
                    {
                        const filtered = users.filter( u => u.role !== 'owner' );

                        if ( filtered.length > 0 )
                        {
                            selContainer.style.display = 'block';
                            sel.innerHTML = '';
                            filtered.forEach( u =>
                            {
                                const opt = document.createElement( 'option' );
                                opt.value = u.name;
                                opt.textContent = u.name; // Removed role for cleaner mobile view
                                sel.appendChild( opt );
                            } );

                            // Set dropdown to current user if possible
                            if ( sel.querySelector( `option[value="${ selUser }"]` ) )
                            {
                                sel.value = selUser;
                            } else
                            {
                                selUser = sel.value; // Default to first available
                            }

                            sel.addEventListener( 'change', () =>
                            {
                                selUser = sel.value;
                                loadCalendar();
                            } );
                        }
                    }

                    // Event Listeners
                    document.getElementById( 'prev-month' ).addEventListener( 'click', () =>
                    {
                        cur.setMonth( cur.getMonth() - 1 );
                        loadCalendar();
                    } );
                    document.getElementById( 'next-month' ).addEventListener( 'click', () =>
                    {
                        cur.setMonth( cur.getMonth() + 1 );
                        loadCalendar();
                    } );
                    document.getElementById( 'today-btn' ).addEventListener( 'click', () =>
                    {
                        cur = new Date();
                        loadCalendar();
                    } );

                    // Initial Load
                    loadCalendar();
                } );
            </script>
    </body>

</html>